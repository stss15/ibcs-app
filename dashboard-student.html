<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard · IBCS App</title>
    <link rel="stylesheet" href="./styles/main.css" />
  </head>
  <body>
    <header>
      <h1>Student dashboard</h1>
      <p>Track locked and unlocked syllabus topics from A1 to B4.</p>
    </header>

    <main>
      <div class="layout">
        <section class="card">
          <h2>Your unlocked topics</h2>
          <div id="unlocked-topics" class="grid two-up"></div>
        </section>

        <section class="card">
          <h2>All topics (A1 – B4)</h2>
          <ul class="placeholder-list" id="all-topics"></ul>
        </section>
      </div>
    </main>

    <footer>
      <small><a href="./index.html">Back to login</a></small>
    </footer>

    <script>
      const WORKER_BASE = "https://ibcs-auth.stevengstewart25.workers.dev";
      const unlocked = document.getElementById("unlocked-topics");
      const allTopics = document.getElementById("all-topics");
      const token = window.localStorage.getItem("ibcs.token");

      const topicCodes = [
        "A1.1","A1.2","A1.3","A1.4",
        "A2.1","A2.2","A2.3","A2.4",
        "A3.1","A3.2","A3.3","A3.4",
        "A4.1","A4.2","A4.3","A4.4",
        "B1.1",
        "B2.1","B2.2","B2.3","B2.4","B2.5",
        "B3.1","B3.2",
        "B4.1",
      ];

      for (const code of topicCodes) {
        const li = document.createElement("li");
        li.textContent = code;
        allTopics.appendChild(li);
      }

      if (token) {
        fetch(`${WORKER_BASE}/t/dashboard`, {
          headers: { authorization: `Bearer ${token}` },
        })
          .then((response) => response.json())
          .then((data) => {
            const topics = data.unlocks ?? [];
            if (!topics.length) {
              unlocked.innerHTML = "<p>No topics unlocked yet.</p>";
              return;
            }
            unlocked.innerHTML = "";
            for (const entry of topics) {
              const card = document.createElement("article");
              card.className = "card";
              card.innerHTML = `
                <strong>${entry.topic?.title ?? entry.topicId}</strong>
                <p>Unlocked at: ${entry.unlockedAt ?? "recently"}</p>
              `;
              unlocked.appendChild(card);
            }
          })
          .catch(() => {
            unlocked.innerHTML = "<p>Unable to fetch topic unlocks.</p>";
          });
      } else {
        unlocked.innerHTML =
          "<p>Authenticate via the login page to view your unlocked topics.</p>";
      }
    </script>
  </body>
</html>
